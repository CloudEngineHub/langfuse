# yaml-language-server: $schema=https://raw.githubusercontent.com/fern-api/fern/main/fern.schema.json
imports:
  pagination: ./utils/pagination.yml
  commons: ./commons.yml
service:
  auth: true
  base-path: /api/public
  endpoints:
    batch:
      docs: Ingest multiple events to Langfuse
      method: POST
      path: /ingestion
      request:
        name: IngestionRequest
        body:
          properties:
            batch: list<IngestionEvent>
      response: IngestionResponse # will be reportet as 200 response, but endpoint returns 207

types:
  IngestionEvent:
    discriminant: "type"
    union:
      trace-create: TraceEvent
      score-create: ScoreEvent
      event-create: EventCreateEvent
      generation-create: GenerationCreateEvent
      generation-update: GenerationUpdateEvent
      span-create: SpanCreateEvent
      span-update: SpanUpdateEvent

      # both are legacy
      observation-create: ObservationCreateEvent
      observation-update: ObservationUpdateEvent

  IngestionUsage:
    discriminated: false
    union:
      - commons.Usage
      - OpenAIUsage
  OpenAIUsage:
    properties:
      promptTokens: optional<integer>
      completionTokens: optional<integer>
      totalTokens: optional<integer>

  OpetionalObservationBody:
    properties:
      traceId: optional<string>
      name: optional<string>
      startTime: optional<datetime>
      metadata: optional<unknown>
      input: optional<unknown>
      output: optional<unknown>
      level: optional<commons.ObservationLevel>
      statusMessage: optional<string>
      parentObservationId: optional<string>
      version: optional<string>

  CreateEventBody:
    extends: OpetionalObservationBody
    properties:
      id: optional<string>

  UpdateEventBody:
    extends: OpetionalObservationBody
    properties:
      id: string

  CreateSpanBody:
    extends: CreateEventBody
    properties:
      endTime: optional<datetime>

  UpdateSpanBody:
    extends: UpdateEventBody
    properties:
      endTime: optional<datetime>

  CreateGenerationBody:
    extends: CreateSpanBody
    properties:
      completionStartTime: optional<datetime>
      model: optional<string>
      modelParameters: optional<map<string, commons.MapValue>>
      usage: optional<IngestionUsage>

  UpdateGenerationBody:
    extends: UpdateSpanBody
    properties:
      completionStartTime: optional<datetime>
      model: optional<string>
      modelParameters: optional<map<string, commons.MapValue>>
      usage: optional<IngestionUsage>

  ObservationBody:
    properties:
      id: optional<string>
      traceId: optional<string>
      type: string
      name: optional<string>
      startTime: optional<datetime>
      endTime: optional<datetime>
      completionStartTime: optional<datetime>
      model: optional<string>
      modelParameters: optional<map<string, commons.MapValue>>
      input: optional<unknown>
      version: optional<string>
      metadata: optional<unknown>
      output: optional<unknown>
      usage: optional<commons.Usage>
      level: optional<commons.ObservationLevel>
      statusMessage: optional<string>
      parentObservationId: optional<string>

  TraceBody:
    properties:
      id: optional<string>
      name: optional<string>
      userId: optional<string>
      input: optional<unknown>
      output: optional<unknown>
      sessionId: optional<string>
      release: optional<string>
      version: optional<string>
      metadata: optional<unknown>
      public:
        type: optional<boolean>
        docs: Make trace publicly accessible via url

  ScoreBody:
    properties:
      id: optional<string>
      traceId: string
      name: string
      value: double
      observationId: optional<string>
      comment: optional<string>

  TraceEvent:
    properties:
      id: string
      timestamp: string
      body: TraceBody

  ObservationCreateEvent:
    properties:
      id: string
      timestamp: string
      body: ObservationBody

  ObservationUpdateEvent:
    properties:
      id: string
      timestamp: string
      body: ObservationBody

  ScoreEvent:
    properties:
      id: string
      timestamp: string
      body: ScoreBody

  GenerationCreateEvent:
    properties:
      id: string
      timestamp: string
      body: CreateGenerationBody

  GenerationUpdateEvent:
    properties:
      id: string
      timestamp: string
      body: UpdateGenerationBody

  SpanCreateEvent:
    properties:
      id: string
      timestamp: string
      body: CreateSpanBody

  SpanUpdateEvent:
    properties:
      id: string
      timestamp: string
      body: UpdateSpanBody

  EventCreateEvent:
    properties:
      id: string
      timestamp: string
      body: CreateEventBody

  IngestionSuccess:
    properties:
      id: string
      status: integer

  IngestionError:
    properties:
      id: string
      status: integer
      message: optional<string>
      error: optional<unknown>

  IngestionResponse:
    properties:
      successes: list<IngestionSuccess>
      errors: list<IngestionError>
